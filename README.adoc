= OCP APP DEV WITH RH PAM


== Making Preperations

=== Access to RH Registry

Directions: https://access.redhat.com/solutions/3812291

	oc create secret generic imagestreamsecret --from-file=.dockerconfigjson=/home/stkousso/Stelios/sw11/PAAS/Distros/minishift/1.27/minishift-1.27.0-linux-amd64/config.json --type=kubernetes.io/dockerconfigjson

=== RHSSO

* Installing link:https://access.redhat.com/documentation/en-us/red_hat_jboss_middleware_for_openshift/3/html-single/red_hat_single_sign-on_for_openshift/#using_the_rh_sso_for_openshift_image_streams_and_application_templates[RHSSO 7.2] Templates & Images

	oc login -u system:admin
	cd ./ocp_pam_app_dev
	./Infrastructure/scripts/prepare_env_sso.sh

	# DEPRECATED
	--------------------
	# oc create -f https://github.com/jboss-container-images/redhat-sso-7-openshift-image/blob/sso72-dev/templates/sso72-image-stream.json -n openshift
	# for resource in sso72-image-stream.json \
	#   sso72-https.json \
	#   sso72-mysql-persistent.json \
	#   sso72-mysql.json \
	#   sso72-postgresql-persistent.json \
	#   sso72-postgresql.json
	# do
	#   oc replace -n openshift --force -f \
	#   https://raw.githubusercontent.com/jboss-openshift/application-templates/ose-v1.4.16/sso/${resource}
	# done


* Run the following command to install the RH-SSO 7.2 OpenShift image streams in the openshift project:

        oc import-image redhat-sso72-openshift:1.0 -n openshift
        oc import-image redhat-sso72-openshift:1.1 -n openshift
        oc import-image redhat-sso72-openshift:1.2 -n openshift

=== Nexus

* *TBD*

=== RHPAM

==== Image Stream

	cd ./ocp_pam_app_dev
	unzip ./resources/rhpam-7.2.0-openshift-templates.zip
        oc get is -n openshift |grep rhpam
	oc create -f ./resources/rhpam72-image-streams.yaml -n openshift
        oc get is -n openshift |grep rhpam

==== Put RHPAM images in place

* Check existing images (as cluster admin). we need rhpam72

	oc get images |grep rhpam

* *Business Central*: A platform for authoring business assets such as data objects, rules, processes, cases, and planning entities.

	oc import-image my-rhpam-7/rhpam72-businesscentral-openshift --from=registry.access.redhat.com/rhpam-7/rhpam72-businesscentral-openshift --confirm -n openshift

* *KIE Server* REST services runtime environment for business assets such as business processes, rules, cases, and planning entities.

	oc import-image my-rhpam-7/rhpam72-kieserver-openshift --from=registry.access.redhat.com/rhpam-7/rhpam72-kieserver-openshift --confirm -n openshift

* *KIE (Standalone) Controller*:  A component for managing multiple KIE Servers (Process, Decision, Planning) in manage mode.

	oc import-image my-rhpam-7/rhpam72-controller-openshift --from=registry.access.redhat.com/rhpam-7/rhpam72-controller-openshift --confirm -n openshift

* *Smart Router*: Load balancing, unified view on available business assets, and aggregation of responses throughout multiple KIE Servers (Process, Decision, Planning).

	oc import-image my-rhpam-7/rhpam72-smartrouter-openshift --from=registry.access.redhat.com/rhpam-7/rhpam72-smartrouter-openshift --confirm -n openshift

* *Business Central Monitoring*: A platform for monitoring and management of business assets.

	oc import-image my-rhpam-7/rhpam72-businesscentral-monitoring-openshift --from=registry.access.redhat.com/rhpam-7/rhpam72-businesscentral-monitoring-openshift --confirm -n openshift

==== Insert Templates

	cd ./ocp_pam_app_dev
	oc create -f ./resources/<template-name> -n openshift

==== Custom Tempates

* Template Name:
** location:
** purpose:



== CI/CD PoC Setups

=== Tools project

	oc new-project <YOUR-TOOLS-NAEMSPACE>tools
	
1. create nexus + rh proxy repos

		cd ./ocp_pam_app_dev
		oc login -u <CLUSTER PUBLIC IP> -u <USERNAME> -p <PASSWORD>
		oc project tools
		# oc create -f nexus-dc.yaml -n tools
		./Infrastructure/scripts/setup_nexus.sh <YOUR-TOOLS-NAEMSPACE>tools <CLUSTER PUBLIC URL>192.168.42.21

2. SSO Setp

		oc login -u <CLUSTER PUBLIC IP> -u <USERNAME> -p <PASSWORD>
		oc project tools
		#oc new-app --template=openshift/sso72-x509-https -p APPLICATION_NAME=cgd-sso -p SSO_ADMIN_USERNAME=ssoadmin -p SSO_ADMIN_PASSWORD=ssoadmin720! -l app=sso -n tools
		./Infrastructure/scripts/setup_sso.sh tools FALSE
		
3. jenkins
4. gogs
5. quay.io?


=== DEV Project

* *Business Central* Installation/Configuration:

	cd ./ocp_pam_app_dev
	oc login -u <CLUSTER PUBLIC IP> -u <USERNAME> -p <PASSWORD>
	oc project pam-dev
	oc create -f Infrastructure/templates/rhpam72-authoring-stelios-1.yaml
	./Infrastructure/scripts/setup_DEV_managed.sh <YOUR-DEV-NAMESPACE>pam-dev <YOUR-TOOLS-NAMESPACE>tools

	KIE Server Check: "curl -u executionUser:executionUser123 --insecure https://secure-cgd-kieserver-<YOUR-DEV-NAMESPACE>.apps.<CLUSTER-NAME>/services/rest/server"
	RHPAM Central Login: rhpamAdmin/rhpamAdmin720

** Create Project
*** *Step 1*: Create processes etc.
*** *Step 2*: since no CI-CD we will distribute KJARs directly from 'Business Central' into NEXUS to achieve this
**** Add on any new project in the settings.xml the following for distribution to NEXUS (*Note: <id>nexus</id> MUST match the'<servers><server><id>nexus</id>' in *Infrastructure/templates/settings.xml*

	 <distributionManagement>
	   <repository>
	     <id>nexus</id>
	     <url>http://<NEXUS-ROUTE>/repository/maven-releases</url>
	   </repository>
	   <snapshotRepository>
	     <id>nexus</id>
	     <url>http://<NEXUS-ROUTE>/repository/maven-snapshots</url>
	   </snapshotRepository>
	 </distributionManagement>	

**** 'Deploy' from 'Business Central' into the KieServer and confirm that KieContainer is started by looking for the appropriate *container-alias*

	curl -u executionUser:executionUser123 -X GET "https://secure-cgd-kieserver-pam-dev.apps.fe44.example.opentlc.com/services/rest/server/containers" --insecure -H  "accept: application/xml"

	<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
	<response type="SUCCESS" msg="List of created containers">
	    <kie-containers>
		<kie-container container-alias="retail-proc-1" container-id="retail-proc-1_1.0.0" status="STARTED">
		    <config-items>
		        <itemName>KBase</itemName>
		        <itemValue></itemValue>
		        <itemType>BPM</itemType>
		    </config-items>
		    <config-items>
		        <itemName>KSession</itemName>
		        <itemValue></itemValue>
		        <itemType>BPM</itemType>
		    </config-items>
		    <config-items>
		        <itemName>MergeMode</itemName>
		        <itemValue>MERGE_COLLECTIONS</itemValue>
		        <itemType>BPM</itemType>
		    </config-items>
		    <config-items>
		        <itemName>RuntimeStrategy</itemName>
		        <itemValue>SINGLETON</itemValue>
		        <itemType>BPM</itemType>
		    </config-items>
		    <messages>
		        <content>Container retail-proc-1_1.0.0 successfully created with module com.cgdretailprocesses:retail-proc-1:1.0.0.</content>
		        <severity>INFO</severity>
		        <timestamp>2019-02-15T16:17:43.934Z</timestamp>
		    </messages>
		    <release-id>
		        <artifact-id>retail-proc-1</artifact-id>
		        <group-id>com.cgdretailprocesses</group-id>
		        <version>1.0.0</version>
		    </release-id>
		    <resolved-release-id>
		        <artifact-id>retail-proc-1</artifact-id>
		        <group-id>com.cgdretailprocesses</group-id>
		        <version>1.0.0</version>
		    </resolved-release-id>
		    <scanner status="DISPOSED"/>
		</kie-container>
	    </kie-containers>
	</response>

***** Check NEXUS where now the KJAR(s) would have been uploaded to and where the DEV KieServer has been configued to download them from Definitions*

	http://nexus3-tools.apps.fe44.example.opentlc.com/#browse/browse:maven-all-public

	image:pics/nexus-kjar-distributed.png["Uploaded KJARs to NEXUS",height=180]

***** Go to Business Central *Menu --> Execution Servers" & Click on the Remote Servers (only one available) too see the KieContainers created from the deployed KJARs

	image:pics/kieserver-dev-kiecontainers-deployed.png["KieContainers active on DEV KieServer",height=180]


**** 'Find' the process in the deployed KJAR (ie. the runnalable RHPAM projet) by using from the previous result the alias or id of the KieContainer (container-alias="retail-proc-1" container-id="retail-proc-1_1.0.0")

	curl -u executionUser:executionUser123 -X GET "https://secure-cgd-kieserver-pam-dev.apps.fe44.example.opentlc.com/services/rest/server/containers/retail-proc-1/processes?page=0&pageSize=10&sortOrder=true" --insecure -H  "accept: application/xml"

	<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
	<process-definitions>
	    <processes>
		<process-id>com.cgdretailprocesses.retail_proc_1.printname</process-id>
		<process-name>printname</process-name>
		<process-version>1.0</process-version>
		<package>com.cgdretailprocesses.retail_proc_1</package>
		<container-id>retail-proc-1_1.0.0</container-id>
		<dynamic>false</dynamic>
	    </processes>
	</process-definitions>

**** 'Execute' against the KieContainer by starting a new process
***** Using the *alias* 

	curl -u executionUser:executionUser123 --insecure -X POST "https://secure-cgd-kieserver-pam-dev.apps.fe44.example.opentlc.com/services/rest/server/containers/retail-proc-1/processes/com.cgdretailprocesses.retail_proc_1.printname/instances" -H  "accept: application/xml" -H  "content-type: application/xml" -d "<?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"yes\"?><map-type>    <entries>        <entry>            <key>age</key>            <value xsi:type=\"xs:int\" xmlns:xs=\"http://www.w3.org/2001/XMLSchema\"                    xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\">25</value>        </entry>        <entry>            <key>person</key>            <value xsi:type=\"person\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\">                <name>john</name>            </value>        </entry>    </entries></map-type>"


	<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
	<long-type>
	      <value>1</value>
	</long-type>

***** Using the *container-id* 

	curl -u executionUser:executionUser123 --insecure -X POST "https://secure-cgd-kieserver-pam-dev.apps.fe44.example.opentlc.com/services/rest/server/containers/retail-proc-1_1.0.0/processes/com.cgdretailprocesses.retail_proc_1.printname/instances" -H  "accept: application/xml" -H  "content-type: application/xml" -d "<?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"yes\"?><map-type>    <entries>        <entry>            <key>age</key>            <value xsi:type=\"xs:int\" xmlns:xs=\"http://www.w3.org/2001/XMLSchema\"                    xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\">25</value>        </entry>        <entry>            <key>person</key>            <value xsi:type=\"person\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\">                <name>john</name>            </value>        </entry>    </entries></map-type>"


	<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
	<long-type>
	      <value>2</value>
	</long-type>

***** To see the current deployed process definitions *Menu --> Process Definitions*

	https://secure-cgd-rhpamcentr-pam-dev.apps.fe44.example.opentlc.com/kie-wb.jsp#ProcessDefinitions%7CProcessDefinitionListScreen

	image:pics/ProcessDefinitions-Diagram.png["Process Definition Diagram",height=180]

***** To see the current deployed process definitions *Menu --> Process Instances*

	image:pics/ProcessInstances-Active-Completed.png["See KIESERVER Process Instances",height=180]

												
=== PROD Project

	cd ./ocp_pam_app_dev
	oc login -u <CLUSTER PUBLIC IP> -u <USERNAME> -p <PASSWORD>
	oc project pam-dev
	oc create -f Infrastructure/templates/rhpam72-prod-stelios-1.yaml
	./Infrastructure/scripts/setup_PROD_managed.sh <YOUR-DEV-NAMESPACE>pam-prod <YOUR-TOOLS-NAMESPACE>tools

* Go to RHPAM Central Monitoring (rhpamadmin/rhpamadmin720)
* Add deployment Unit to correct kieserver cluster
* execute against smartrouter/kieserver directly as executionUser/executionUser123

	

=== ERRORS

==== BC

=== KIESERVER

	








